# Medicare Benchmark Dimension Tables Schema

This document describes the structure and schema of the Medicare benchmark dimension tables generated by `build_medicare_benchmarks.py`.

## Overview

The Medicare benchmark tables provide comprehensive reference rates for:
- **Professional Services** (CPT codes) - Physician services
- **OPPS** (HCPCS codes) - Hospital outpatient services  
- **ASC** (HCPCS codes) - Ambulatory Surgery Center services

Each table includes both **national rates** and **state-averaged rates** for comprehensive benchmarking.

## File Structure

```
prod_etl/core/data/silver/benchmarks/
├── bench_medicare_professional.parquet    # Professional service benchmarks
├── bench_medicare_opps.parquet           # OPPS benchmarks
├── bench_medicare_asc.parquet            # ASC benchmarks
└── bench_medicare_comprehensive.parquet  # Combined all benchmarks
```

## Table Schemas

### 1. Professional Benchmarks (`bench_medicare_professional.parquet`)

**Purpose**: Medicare professional service rates for physician services (CPT codes)

**Key Structure**: `(state, year_month, code_type, code)`

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `state` | String | US state code | "GA" |
| `year_month` | String | Year-month (YYYY-MM) | "2025-01" |
| `code_type` | String | Code system | "CPT" |
| `code` | String | Procedure code | "99213" |
| `medicare_prof_national` | Float64 | National professional rate | 85.25 |
| `medicare_prof_stateavg` | Float64 | State-averaged professional rate | 87.50 |
| `work_rvu` | Float64 | Work RVU component | 0.67 |
| `practice_expense_rvu` | Float64 | Practice expense RVU | 0.25 |
| `malpractice_rvu` | Float64 | Malpractice RVU | 0.03 |
| `conversion_factor` | Float64 | Medicare conversion factor | 34.89 |
| `benchmark_type` | String | Benchmark category | "professional" |
| `created_date` | Timestamp | Creation timestamp | 2025-01-15 10:30:00 |
| `data_year` | Int64 | Data year | 2025 |

**Rate Calculation**:
```
Professional Rate = (Work_RVU × Work_GPCI + PE_RVU × PE_GPCI + MP_RVU × MP_GPCI) × Conversion_Factor
```

### 2. OPPS Benchmarks (`bench_medicare_opps.parquet`)

**Purpose**: Medicare OPPS rates for hospital outpatient services (HCPCS codes)

**Key Structure**: `(state, year_month, code_type, code)`

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `state` | String | US state code | "GA" |
| `year_month` | String | Year-month (YYYY-MM) | "2025-01" |
| `code_type` | String | Code system | "HCPCS" |
| `code` | String | Procedure code | "99213" |
| `medicare_opps_national` | Float64 | National OPPS rate | 89.17 |
| `medicare_opps_stateavg` | Float64 | State-averaged OPPS rate | 91.25 |
| `opps_weight` | Float64 | OPPS relative weight | 1.0 |
| `opps_si` | String | OPPS status indicator | "1" |
| `opps_short_desc` | String | Short description | "Office visit" |
| `state_wage_index_avg` | Float64 | State wage index average | 0.95 |
| `opps_adj_factor_stateavg` | Float64 | State adjustment factor | 0.97 |
| `benchmark_type` | String | Benchmark category | "opps" |
| `created_date` | Timestamp | Creation timestamp | 2025-01-15 10:30:00 |
| `data_year` | Int64 | Data year | 2025 |

**Rate Calculation**:
```
OPPS Rate = OPPS_Weight × OPPS_Conversion_Factor × (Labor_Share × State_Wage_Index + Non_Labor_Share)
```

### 3. ASC Benchmarks (`bench_medicare_asc.parquet`)

**Purpose**: Medicare ASC rates for ambulatory surgery center services (HCPCS codes)

**Key Structure**: `(state, year_month, code_type, code)`

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `state` | String | US state code | "GA" |
| `year_month` | String | Year-month (YYYY-MM) | "2025-01" |
| `code_type` | String | Code system | "CPT" |
| `code` | String | Procedure code | "99213" |
| `medicare_asc_national` | Float64 | National ASC rate | 54.90 |
| `medicare_asc_stateavg` | Float64 | State-averaged ASC rate | 56.25 |
| `asc_pi` | String | ASC payment indicator | "1" |
| `asc_nat_rate` | Float64 | ASC national rate | 54.90 |
| `asc_short_desc` | String | Short description | "Surgery" |
| `state_wage_index_avg` | Float64 | State wage index average | 0.95 |
| `asc_adj_factor_stateavg` | Float64 | State adjustment factor | 0.975 |
| `benchmark_type` | String | Benchmark category | "asc" |
| `created_date` | Timestamp | Creation timestamp | 2025-01-15 10:30:00 |
| `data_year` | Int64 | Data year | 2025 |

**Rate Calculation**:
```
ASC Rate = ASC_National_Rate × (Labor_Share × State_Wage_Index + Non_Labor_Share)
```

### 4. Comprehensive Benchmarks (`bench_medicare_comprehensive.parquet`)

**Purpose**: Combined table with all Medicare benchmark types

**Key Structure**: `(state, year_month, code_type, code, benchmark_type)`

Contains all columns from the individual benchmark tables plus:
- `table_version` (String): Version of the comprehensive table
- `last_updated` (Timestamp): Last update timestamp

## Usage Examples

### 1. Join with Fact Table for Benchmarking

```python
import pandas as pd

# Load fact table and benchmarks
fact = pd.read_parquet('prod_etl/core/data/gold/fact_rate.parquet')
benchmarks = pd.read_parquet('prod_etl/core/data/silver/benchmarks/bench_medicare_comprehensive.parquet')

# Join for professional rate benchmarking
fact_with_benchmarks = fact.merge(
    benchmarks[benchmarks['benchmark_type'] == 'professional'],
    on=['state', 'year_month', 'code_type', 'code'],
    how='left'
)

# Calculate percentage of Medicare
fact_with_benchmarks['pct_of_medicare'] = (
    fact_with_benchmarks['negotiated_rate'] / 
    fact_with_benchmarks['medicare_prof_stateavg']
)
```

### 2. DuckDB Query for Benchmark Analysis

```sql
-- Compare negotiated rates to Medicare benchmarks
WITH fact AS (
  SELECT *
  FROM read_parquet('prod_etl/core/data/gold/fact_rate.parquet')
  WHERE state = 'GA' AND year_month = '2025-01'
),
benchmarks AS (
  SELECT *
  FROM read_parquet('prod_etl/core/data/silver/benchmarks/bench_medicare_comprehensive.parquet')
  WHERE state = 'GA' AND year_month = '2025-01'
)
SELECT 
  f.reporting_entity_name,
  f.code_type,
  f.code,
  f.negotiated_rate,
  b.medicare_prof_stateavg,
  f.negotiated_rate / NULLIF(b.medicare_prof_stateavg, 0) AS pct_of_medicare
FROM fact f
LEFT JOIN benchmarks b ON (
  b.state = f.state AND 
  b.year_month = f.year_month AND 
  b.code_type = f.code_type AND 
  b.code = f.code AND
  b.benchmark_type = 'professional'
)
WHERE b.medicare_prof_stateavg IS NOT NULL
ORDER BY pct_of_medicare DESC
LIMIT 100;
```

### 3. State-Level Benchmark Analysis

```python
# Analyze state-level Medicare rate variations
state_analysis = benchmarks.groupby(['state', 'benchmark_type']).agg({
    'medicare_prof_stateavg': 'mean',
    'medicare_opps_stateavg': 'mean', 
    'medicare_asc_stateavg': 'mean'
}).reset_index()

# Compare to national averages
national_analysis = benchmarks.groupby('benchmark_type').agg({
    'medicare_prof_national': 'mean',
    'medicare_opps_national': 'mean',
    'medicare_asc_national': 'mean'
}).reset_index()
```

## Key Benefits

1. **Comprehensive Coverage**: All states and procedure codes covered
2. **Multiple Rate Types**: Both national and state-averaged rates
3. **Easy Joining**: Consistent key structure for fact table joins
4. **Flexible Analysis**: Support for various benchmarking scenarios
5. **Audit Trail**: Creation dates and data lineage included

## Data Quality Notes

- **State Averages**: Calculated using weighted averages of locality-specific values
- **Missing Data**: Handled gracefully with appropriate defaults
- **Rate Validation**: All rates calculated using official CMS formulas
- **Consistency**: Same calculation methods as existing Medicare calculator

## Maintenance

- **Annual Updates**: Rebuild tables when new Medicare data is released
- **Version Control**: Track table versions for data lineage
- **Validation**: Compare against official CMS published rates
- **Performance**: Optimize parquet files for query performance
